{% extends "base.html" %}
{% block title %}Resource Optimizer | Kisan Mitra{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-success"><i class="fas fa-cogs me-3"></i>Resource Optimizer</h1>
        <p class="lead text-muted">Optimize water and fertilizer usage with smart AI-powered calculators.</p>
    </div>

    <ul class="nav nav-pills justify-content-center mb-4" id="resourceTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="irrigation-tab" data-bs-toggle="tab" data-bs-target="#irrigation" type="button" role="tab"><i class="fas fa-tint me-2"></i>Irrigation</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="fertilizer-tab" data-bs-toggle="tab" data-bs-target="#fertilizer" type="button" role="tab"><i class="fas fa-seedling me-2"></i>Fertilizer</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="soil-health-tab" data-bs-toggle="tab" data-bs-target="#soil-health" type="button" role="tab"><i class="fas fa-microscope me-2"></i>Soil Health</button>
        </li>
    </ul>

    <div class="tab-content" id="resourceTabsContent">
        <div class="tab-pane fade show active" id="irrigation" role="tabpanel">
            <div class="row mt-4">
                <div class="col-lg-8 mx-auto">
                    <div class="card card-body shadow-sm">
                        <h3 class="text-center mb-4"><i class="fas fa-calculator me-2"></i>Smart Irrigation Calculator</h3>
                        <form id="irrigationForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="irrigationCrop" class="form-label">Crop Type</label>
                                    <select class="form-select" id="irrigationCrop" name="crop_type" required>
                                        <option value="Sugarcane">Sugarcane</option>
                                        <option value="Cotton">Cotton</option>
                                        <option value="Soybean">Soybean</option>
                                        <option value="Wheat">Wheat</option>
                                        <option value="Rice">Rice</option>
                                        <option value="Maize">Maize</option>
                                        <option value="Tomato">Tomato</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="irrigationSoil" class="form-label">Soil Type</label>
                                    <select class="form-select" id="irrigationSoil" name="soil_type" required>
                                        <option value="Loamy Soil">Loamy Soil</option>
                                        <option value="Clay Soil">Clay Soil</option>
                                        <option value="Sandy Soil">Sandy Soil</option>
                                        <option value="Black Soil">Black Soil</option>
                                        <option value="Red Soil">Red Soil</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3"><label for="landAreaIrrigation" class="form-label">Land Area (Acres)</label><input type="number" class="form-control" id="landAreaIrrigation" name="land_area" min="0.1" step="0.1" value="5.1" required></div>
                                <div class="col-md-6 mb-3">
                                    <label for="weatherCondition" class="form-label">Weather Condition</label>
                                    <select class="form-select" id="weatherCondition" name="weather" required>
                                        <option value="Sunny">Sunny</option>
                                        <option value="Cloudy">Cloudy</option>
                                        <option value="Rainy">Rainy</option>
                                        <option value="Hot and Dry">Hot & Dry</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="growthStage" class="form-label">Growth Stage</label>
                                     <select class="form-select" id="growthStage" name="growth_stage" required>
                                        <option value="Vegetative">Vegetative</option>
                                        <option value="Seedling">Seedling</option>
                                        <option value="Flowering">Flowering</option>
                                        <option value="Fruiting">Fruiting</option>
                                        <option value="Maturity">Maturity</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-center mt-3"><button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-calculator me-2"></i>Calculate Irrigation</button></div>
                        </form>
                    </div>
                    <div id="irrigationResults" style="display: none;" class="results-container mt-4"></div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="fertilizer" role="tabpanel">
             <div class="row mt-4">
                <div class="col-lg-8 mx-auto">
                    <div class="card card-body shadow-sm">
                        <h3 class="text-center mb-4"><i class="fas fa-seedling me-2"></i>Fertilizer Recommendation Guide</h3>
                        <form id="fertilizerForm">
                             <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="fertilizerCrop" class="form-label">Crop Type</label>
                                    <select class="form-select" name="crop_type" id="fertilizerCrop" required>
                                        <option value="Cotton">Cotton</option>
                                        <option value="Sugarcane">Sugarcane</option>
                                        <option value="Soybean">Soybean</option>
                                        <option value="Wheat">Wheat</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="fertilizerSoil" class="form-label">Soil Type</label>
                                    <select class="form-select" name="soil_type" id="fertilizerSoil" required>
                                        <option value="Black Soil">Black Soil</option>
                                        <option value="Red Soil">Red Soil</option>
                                        <option value="Loamy Soil">Loamy Soil</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="fertilizerStage" class="form-label">Growth Stage</label>
                                    <select class="form-select" name="growth_stage" id="fertilizerStage" required>
                                        <option value="Flowering">Flowering</option>
                                        <option value="Vegetative">Vegetative</option>
                                        <option value="Seedling">Seedling</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-center mt-3"><button type="submit" class="btn btn-success btn-lg"><i class="fas fa-search me-2"></i>Get Fertilizer Guide</button></div>
                        </form>
                    </div>
                    <div id="fertilizerResults" style="display: none;" class="results-container mt-4"></div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="soil-health" role="tabpanel">
            <div class="row mt-4">
                <div class="col-lg-8 mx-auto">
                    <div class="card card-body shadow-sm">
                         <h3 class="text-center mb-4"><i class="fas fa-microscope me-2"></i>Soil Health Analysis</h3>
                        <form id="soilHealthForm">
                            <p class="text-center text-muted">Enter values from your soil test report.</p>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="soilAnalysisType" class="form-label">Soil Type</label>
                                    <select class="form-select" name="soil_type" id="soilAnalysisType" required>
                                        <option value="Red Soil">Red Soil</option>
                                        <option value="Black Soil">Black Soil</option>
                                        <option value="Loamy Soil">Loamy Soil</option>
                                        <option value="Alluvial Soil">Alluvial Soil</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3"><label for="phLevel" class="form-label">pH Level</label><input type="number" step="0.1" class="form-control" name="ph_level" id="phLevel" required value="6.8"></div>
                                <div class="col-md-4 mb-3"><label for="organicMatter" class="form-label">Organic Matter (%)</label><input type="number" step="0.1" class="form-control" name="organic_matter" id="organicMatter" required value="1.2"></div>
                                <div class="col-md-4 mb-3"><label for="nitrogen" class="form-label">Nitrogen (N) kg/ha</label><input type="number" class="form-control" name="nitrogen" id="nitrogen" required value="120"></div>
                                <div class="col-md-4 mb-3"><label for="phosphorus" class="form-label">Phosphorus (P) kg/ha</label><input type="number" class="form-control" name="phosphorus" id="phosphorus" required value="25"></div>
                                <div class="col-md-4 mb-3"><label for="potassium" class="form-label">Potassium (K) kg/ha</label><input type="number" class="form-control" name="potassium" id="potassium" required value="150"></div>
                            </div>
                            <div class="text-center mt-3"><button type="submit" class="btn btn-info btn-lg"><i class="fas fa-vial me-2"></i>Analyze Soil Health</button></div>
                        </form>
                    </div>
                     <div id="soilHealthResults" style="display: none;" class="results-container mt-4"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Irrigation Calculator ---
    const irrigationForm = document.getElementById('irrigationForm');
    irrigationForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        const resultsDiv = document.getElementById('irrigationResults');
        const submitBtn = e.target.querySelector('button[type="submit"]');
        await handleApiRequest(submitBtn, '/api/irrigation-calculator', data, displayIrrigationResults, resultsDiv);
    });

    function displayIrrigationResults(data, container) {
        container.innerHTML = `
            <h4 class="text-center mb-4"><i class="fas fa-tint me-2"></i>Irrigation Recommendations</h4>
            <div class="row">
                <div class="col-md-6 mb-3"><div class="card text-center h-100"><div class="card-body"><h5>Water Required</h5><div class="fs-2 fw-bold text-info">${data.water_needed_liters_per_acre} L</div><small class="text-muted">per acre</small></div></div></div>
                <div class="col-md-6 mb-3"><div class="card text-center h-100"><div class="card-body"><h5>Frequency</h5><div class="fs-2 fw-bold text-success">${data.frequency}</div><small class="text-muted">recommended interval</small></div></div></div>
            </div>
            <div class="alert alert-light mt-3"><strong>Method Feedback:</strong> ${data.method_feedback}</div>
            <div class="alert alert-light"><strong>Optimization Tips:</strong> ${data.optimization_tips}</div>
        `;
    }

    // --- Fertilizer Calculator ---
    const fertilizerForm = document.getElementById('fertilizerForm');
    fertilizerForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        const resultsDiv = document.getElementById('fertilizerResults');
        const submitBtn = e.target.querySelector('button[type="submit"]');
        await handleApiRequest(submitBtn, '/api/fertilizer-recommendation', data, displayFertilizerResults, resultsDiv);
    });

    function displayFertilizerResults(data, container) {
        container.innerHTML = `
            <h4 class="text-center mb-4"><i class="fas fa-flask me-2"></i>Fertilizer Recommendations</h4>
            <div class="card-group text-center">
                <div class="card"><div class="card-body"><h5 class="text-success">Nitrogen (N)</h5><div class="fs-3 fw-bold">${data.quantity_per_acre.nitrogen}</div><small>per acre</small></div></div>
                <div class="card"><div class="card-body"><h5 class="text-warning">Phosphorus (P)</h5><div class="fs-3 fw-bold">${data.quantity_per_acre.phosphorus}</div><small>per acre</small></div></div>
                <div class="card"><div class="card-body"><h5 class="text-info">Potassium (K)</h5><div class="fs-3 fw-bold">${data.quantity_per_acre.potassium}</div><small>per acre</small></div></div>
            </div>
            <div class="alert alert-light mt-3"><h6><i class="fas fa-info-circle me-2"></i>Application Guidelines</h6>
                <ul class="mb-0">
                    <li><strong>Timing:</strong> ${data.application_timing}</li>
                    <li><strong>Organic Options:</strong> ${data.organic_alternatives}</li>
                </ul>
            </div>
        `;
    }

    // --- Soil Health Calculator ---
    const soilHealthForm = document.getElementById('soilHealthForm');
    soilHealthForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target).entries());
        const resultsDiv = document.getElementById('soilHealthResults');
        const submitBtn = e.target.querySelector('button[type="submit"]');
        await handleApiRequest(submitBtn, '/api/soil-health-analysis', data, displaySoilHealthResults, resultsDiv);
    });

    function displaySoilHealthResults(data, container) {
        container.innerHTML = `
             <h4 class="text-center mb-4"><i class="fas fa-vial me-2"></i>Soil Health Analysis</h4>
             <div class="text-center mb-3"><h4>Overall Score: <span class="badge bg-success">${data.soil_health_score} (${data.health_status})</span></h4></div>
             <div class="row">
                <div class="col-md-6"><div class="card mb-3"><div class="card-header">Nutrient Analysis</div><ul class="list-group list-group-flush"><li class="list-group-item">Nitrogen: <strong>${data.nutrient_analysis.nitrogen_status}</strong></li><li class="list-group-item">Phosphorus: <strong>${data.nutrient_analysis.phosphorus_status}</strong></li><li class="list-group-item">Potassium: <strong>${data.nutrient_analysis.potassium_status}</strong></li></ul></div></div>
                <div class="col-md-6"><div class="card mb-3"><div class="card-header">pH Analysis</div><div class="card-body"><h6 class="card-title">${data.ph_analysis.current_status}</h6><p class="card-text">${data.ph_analysis.recommendation}</p></div></div></div>
             </div>
             <div class="alert alert-light"><strong>Suitable Crops:</strong> ${data.suitable_crops.join(', ')}</div>
             <div class="alert alert-light"><strong>Recommended Amendments:</strong> ${data.soil_amendments.join(', ')}</div>
        `;
    }

    // --- Universal API Handler ---
    async function handleApiRequest(button, url, data, displayFunction, resultsContainer) {
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analyzing...';
        button.disabled = true;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error || 'API request failed');
            }
            const result = await response.json();
            displayFunction(result, resultsContainer);
            resultsContainer.style.display = 'block';
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
            console.error('Error:', error);
            alert('Error: ' + error.message);
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }
});
</script>
{% endblock %}